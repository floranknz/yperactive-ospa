{"version":3,"names":["_blocks","require","_components","_data","_blockEditor","_hooks","_i18n","_compose","findFirstOfSameType","blocks","name","Array","isArray","length","block","firstBlock","innerBlocks","enhance","compose","withSelect","select","multiple","hasBlockSupport","blockEditorStore","getBlocks","firstOfSameType","isInvalid","clientId","originalBlockClientId","withDispatch","dispatch","selectFirst","selectBlock","withMultipleValidation","createHigherOrderComponent","BlockEdit","props","_react","createElement","blockType","getBlockType","outboundType","getOutboundType","key","style","minHeight","Warning","actions","Button","variant","onClick","__","onReplace","createBlock","attributes","title","blockName","transform","findTransform","getBlockTransforms","type","addFilter"],"sources":["@wordpress/edit-post/src/hooks/validate-multiple-use/index.js"],"sourcesContent":["/**\n * WordPress dependencies\n */\nimport {\n\tcreateBlock,\n\tfindTransform,\n\tgetBlockTransforms,\n\tgetBlockType,\n\thasBlockSupport,\n} from '@wordpress/blocks';\nimport { Button } from '@wordpress/components';\nimport { withSelect, withDispatch } from '@wordpress/data';\nimport { Warning, store as blockEditorStore } from '@wordpress/block-editor';\nimport { addFilter } from '@wordpress/hooks';\nimport { __ } from '@wordpress/i18n';\nimport { compose, createHigherOrderComponent } from '@wordpress/compose';\n\n/**\n * Recursively find very first block of an specific block type.\n *\n * @param {Object[]} blocks List of blocks.\n * @param {string}   name   Block name to search.\n *\n * @return {Object|undefined} Return block object or undefined.\n */\nfunction findFirstOfSameType( blocks, name ) {\n\tif ( ! Array.isArray( blocks ) || ! blocks.length ) {\n\t\treturn;\n\t}\n\n\tfor ( const block of blocks ) {\n\t\tif ( block.name === name ) {\n\t\t\treturn block;\n\t\t}\n\n\t\t// Search inside innerBlocks.\n\t\tconst firstBlock = findFirstOfSameType( block.innerBlocks, name );\n\n\t\tif ( firstBlock ) {\n\t\t\treturn firstBlock;\n\t\t}\n\t}\n}\n\nconst enhance = compose(\n\t/**\n\t * For blocks whose block type doesn't support `multiple`, provides the\n\t * wrapped component with `originalBlockClientId` -- a reference to the\n\t * first block of the same type in the content -- if and only if that\n\t * \"original\" block is not the current one. Thus, an inexisting\n\t * `originalBlockClientId` prop signals that the block is valid.\n\t *\n\t * @param {Component} WrappedBlockEdit A filtered BlockEdit instance.\n\t *\n\t * @return {Component} Enhanced component with merged state data props.\n\t */\n\twithSelect( ( select, block ) => {\n\t\tconst multiple = hasBlockSupport( block.name, 'multiple', true );\n\n\t\t// For block types with `multiple` support, there is no \"original\n\t\t// block\" to be found in the content, as the block itself is valid.\n\t\tif ( multiple ) {\n\t\t\treturn {};\n\t\t}\n\n\t\t// Otherwise, only pass `originalBlockClientId` if it refers to a different\n\t\t// block from the current one.\n\t\tconst blocks = select( blockEditorStore ).getBlocks();\n\t\tconst firstOfSameType = findFirstOfSameType( blocks, block.name );\n\t\tconst isInvalid =\n\t\t\tfirstOfSameType && firstOfSameType.clientId !== block.clientId;\n\t\treturn {\n\t\t\toriginalBlockClientId: isInvalid && firstOfSameType.clientId,\n\t\t};\n\t} ),\n\twithDispatch( ( dispatch, { originalBlockClientId } ) => ( {\n\t\tselectFirst: () =>\n\t\t\tdispatch( blockEditorStore ).selectBlock( originalBlockClientId ),\n\t} ) )\n);\n\nconst withMultipleValidation = createHigherOrderComponent( ( BlockEdit ) => {\n\treturn enhance( ( { originalBlockClientId, selectFirst, ...props } ) => {\n\t\tif ( ! originalBlockClientId ) {\n\t\t\treturn <BlockEdit { ...props } />;\n\t\t}\n\n\t\tconst blockType = getBlockType( props.name );\n\t\tconst outboundType = getOutboundType( props.name );\n\n\t\treturn [\n\t\t\t<div key=\"invalid-preview\" style={ { minHeight: '60px' } }>\n\t\t\t\t<BlockEdit key=\"block-edit\" { ...props } />\n\t\t\t</div>,\n\t\t\t<Warning\n\t\t\t\tkey=\"multiple-use-warning\"\n\t\t\t\tactions={ [\n\t\t\t\t\t<Button\n\t\t\t\t\t\tkey=\"find-original\"\n\t\t\t\t\t\tvariant=\"secondary\"\n\t\t\t\t\t\tonClick={ selectFirst }\n\t\t\t\t\t>\n\t\t\t\t\t\t{ __( 'Find original' ) }\n\t\t\t\t\t</Button>,\n\t\t\t\t\t<Button\n\t\t\t\t\t\tkey=\"remove\"\n\t\t\t\t\t\tvariant=\"secondary\"\n\t\t\t\t\t\tonClick={ () => props.onReplace( [] ) }\n\t\t\t\t\t>\n\t\t\t\t\t\t{ __( 'Remove' ) }\n\t\t\t\t\t</Button>,\n\t\t\t\t\toutboundType && (\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tkey=\"transform\"\n\t\t\t\t\t\t\tvariant=\"secondary\"\n\t\t\t\t\t\t\tonClick={ () =>\n\t\t\t\t\t\t\t\tprops.onReplace(\n\t\t\t\t\t\t\t\t\tcreateBlock(\n\t\t\t\t\t\t\t\t\t\toutboundType.name,\n\t\t\t\t\t\t\t\t\t\tprops.attributes\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{ __( 'Transform into:' ) } { outboundType.title }\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t),\n\t\t\t\t] }\n\t\t\t>\n\t\t\t\t<strong>{ blockType?.title }: </strong>\n\t\t\t\t{ __( 'This block can only be used once.' ) }\n\t\t\t</Warning>,\n\t\t];\n\t} );\n}, 'withMultipleValidation' );\n\n/**\n * Given a base block name, returns the default block type to which to offer\n * transforms.\n *\n * @param {string} blockName Base block name.\n *\n * @return {?Object} The chosen default block type.\n */\nfunction getOutboundType( blockName ) {\n\t// Grab the first outbound transform.\n\tconst transform = findTransform(\n\t\tgetBlockTransforms( 'to', blockName ),\n\t\t( { type, blocks } ) => type === 'block' && blocks.length === 1 // What about when .length > 1?\n\t);\n\n\tif ( ! transform ) {\n\t\treturn null;\n\t}\n\n\treturn getBlockType( transform.blocks[ 0 ] );\n}\n\naddFilter(\n\t'editor.BlockEdit',\n\t'core/edit-post/validate-multiple-use/with-multiple-validation',\n\twithMultipleValidation\n);\n"],"mappings":"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","ignoreList":[]}