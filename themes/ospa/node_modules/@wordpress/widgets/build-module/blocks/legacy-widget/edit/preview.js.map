{"version":3,"names":["clsx","useRefEffect","useEffect","useState","Disabled","Placeholder","Spinner","__","apiFetch","Preview","idBase","instance","isVisible","isLoaded","setIsLoaded","srcDoc","setSrcDoc","abortController","window","AbortController","undefined","fetchPreviewHTML","restRoute","path","method","signal","data","then","response","preview","catch","error","name","abort","ref","iframe","setHeight","_iframe$contentDocume","_iframe$contentDocume2","height","Math","max","contentDocument","documentElement","offsetHeight","body","style","IntersectionObserver","ownerDocument","defaultView","intersectionObserver","entry","isIntersecting","threshold","observe","addEventListener","disconnect","removeEventListener","createElement","Fragment","className","tabIndex","title","onLoad","event","target","overflow"],"sources":["@wordpress/widgets/src/blocks/legacy-widget/edit/preview.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport clsx from 'clsx';\n\n/**\n * WordPress dependencies\n */\nimport { useRefEffect } from '@wordpress/compose';\nimport { useEffect, useState } from '@wordpress/element';\nimport { Disabled, Placeholder, Spinner } from '@wordpress/components';\nimport { __ } from '@wordpress/i18n';\nimport apiFetch from '@wordpress/api-fetch';\n\nexport default function Preview( { idBase, instance, isVisible } ) {\n\tconst [ isLoaded, setIsLoaded ] = useState( false );\n\tconst [ srcDoc, setSrcDoc ] = useState( '' );\n\n\tuseEffect( () => {\n\t\tconst abortController =\n\t\t\ttypeof window.AbortController === 'undefined'\n\t\t\t\t? undefined\n\t\t\t\t: new window.AbortController();\n\n\t\tasync function fetchPreviewHTML() {\n\t\t\tconst restRoute = `/wp/v2/widget-types/${ idBase }/render`;\n\t\t\treturn await apiFetch( {\n\t\t\t\tpath: restRoute,\n\t\t\t\tmethod: 'POST',\n\t\t\t\tsignal: abortController?.signal,\n\t\t\t\tdata: instance ? { instance } : {},\n\t\t\t} );\n\t\t}\n\n\t\tfetchPreviewHTML()\n\t\t\t.then( ( response ) => {\n\t\t\t\tsetSrcDoc( response.preview );\n\t\t\t} )\n\t\t\t.catch( ( error ) => {\n\t\t\t\tif ( 'AbortError' === error.name ) {\n\t\t\t\t\t// We don't want to log aborted requests.\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthrow error;\n\t\t\t} );\n\n\t\treturn () => abortController?.abort();\n\t}, [ idBase, instance ] );\n\n\t// Resize the iframe on either the load event, or when the iframe becomes visible.\n\tconst ref = useRefEffect(\n\t\t( iframe ) => {\n\t\t\t// Only set height if the iframe is loaded,\n\t\t\t// or it will grow to an unexpected large height in Safari if it's hidden initially.\n\t\t\tif ( ! isLoaded ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// If the preview frame has another origin then this won't work.\n\t\t\t// One possible solution is to add custom script to call `postMessage` in the preview frame.\n\t\t\t// Or, better yet, we migrate away from iframe.\n\t\t\tfunction setHeight() {\n\t\t\t\t// Pick the maximum of these two values to account for margin collapsing.\n\t\t\t\tconst height = Math.max(\n\t\t\t\t\tiframe.contentDocument.documentElement?.offsetHeight ?? 0,\n\t\t\t\t\tiframe.contentDocument.body?.offsetHeight ?? 0\n\t\t\t\t);\n\n\t\t\t\t// Fallback to a height of 100px if the height cannot be determined.\n\t\t\t\t// This ensures the block is still selectable. 100px should hopefully\n\t\t\t\t// be not so big that it's annoying, and not so small that nothing\n\t\t\t\t// can be seen.\n\t\t\t\tiframe.style.height = `${ height !== 0 ? height : 100 }px`;\n\t\t\t}\n\n\t\t\tconst { IntersectionObserver } = iframe.ownerDocument.defaultView;\n\n\t\t\t// Observe for intersections that might cause a change in the height of\n\t\t\t// the iframe, e.g. a Widget Area becoming expanded.\n\t\t\tconst intersectionObserver = new IntersectionObserver(\n\t\t\t\t( [ entry ] ) => {\n\t\t\t\t\tif ( entry.isIntersecting ) {\n\t\t\t\t\t\tsetHeight();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tthreshold: 1,\n\t\t\t\t}\n\t\t\t);\n\t\t\tintersectionObserver.observe( iframe );\n\n\t\t\tiframe.addEventListener( 'load', setHeight );\n\n\t\t\treturn () => {\n\t\t\t\tintersectionObserver.disconnect();\n\t\t\t\tiframe.removeEventListener( 'load', setHeight );\n\t\t\t};\n\t\t},\n\t\t[ isLoaded ]\n\t);\n\n\treturn (\n\t\t<>\n\t\t\t{ /*\n\t\t\tWhile the iframe contents are loading, we move the iframe off-screen\n\t\t\tand display a placeholder instead. This ensures that the user\n\t\t\tdoesn't see the iframe resize (which looks really janky). We have to\n\t\t\tmove the iframe off-screen instead of hiding it because web browsers\n\t\t\twill not trigger onLoad if the iframe is hidden.\n\t\t\t*/ }\n\t\t\t{ isVisible && ! isLoaded && (\n\t\t\t\t<Placeholder>\n\t\t\t\t\t<Spinner />\n\t\t\t\t</Placeholder>\n\t\t\t) }\n\t\t\t<div\n\t\t\t\tclassName={ clsx( 'wp-block-legacy-widget__edit-preview', {\n\t\t\t\t\t'is-offscreen': ! isVisible || ! isLoaded,\n\t\t\t\t} ) }\n\t\t\t>\n\t\t\t\t<Disabled>\n\t\t\t\t\t{ /*\n\t\t\t\t\tWe use an iframe so that the widget has an opportunity to\n\t\t\t\t\tload scripts and styles that it needs to run.\n\t\t\t\t\t*/ }\n\t\t\t\t\t<iframe\n\t\t\t\t\t\tref={ ref }\n\t\t\t\t\t\tclassName=\"wp-block-legacy-widget__edit-preview-iframe\"\n\t\t\t\t\t\ttabIndex=\"-1\"\n\t\t\t\t\t\ttitle={ __( 'Legacy Widget Preview' ) }\n\t\t\t\t\t\tsrcDoc={ srcDoc }\n\t\t\t\t\t\tonLoad={ ( event ) => {\n\t\t\t\t\t\t\t// To hide the scrollbars of the preview frame for some edge cases,\n\t\t\t\t\t\t\t// such as negative margins in the Gallery Legacy Widget.\n\t\t\t\t\t\t\t// It can't be scrolled anyway.\n\t\t\t\t\t\t\t// TODO: Ideally, this should be fixed in core.\n\t\t\t\t\t\t\tevent.target.contentDocument.body.style.overflow =\n\t\t\t\t\t\t\t\t'hidden';\n\n\t\t\t\t\t\t\tsetIsLoaded( true );\n\t\t\t\t\t\t} }\n\t\t\t\t\t\theight={ 100 }\n\t\t\t\t\t/>\n\t\t\t\t</Disabled>\n\t\t\t</div>\n\t\t</>\n\t);\n}\n"],"mappings":"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","ignoreList":[]}